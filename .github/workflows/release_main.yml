name: Main Release & Publish

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  release-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Next Version
        id: version
        run: |
          YEAR=$(date +'%Y')
          MONTH=$(date +'%m')
          PREFIX="${YEAR}.${MONTH}"
          
          # Find highest existing tag for this month
          LAST_TAG=$(git tag --list "${PREFIX}.*" | sort -V | tail -n 1)
          
          if [ -z "$LAST_TAG" ]; then
            NEW_TAG="${PREFIX}.0"
          else
            COUNTER=$(echo $LAST_TAG | awk -F. '{print $3}')
            NEXT_COUNTER=$((COUNTER + 1))
            NEW_TAG="${PREFIX}.${NEXT_COUNTER}"
          fi
          
          echo "Computed Version: $NEW_TAG"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.new_tag }}"
          echo "Creating release for $TAG with auto-generated notes..."
          
          # Create release using GitHub CLI
          # --generate-notes automatically creates the changelog from PRs
          gh release create "$TAG" \
            --title "Release $TAG" \
            --generate-notes \
            --target "main"

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.new_tag }}
